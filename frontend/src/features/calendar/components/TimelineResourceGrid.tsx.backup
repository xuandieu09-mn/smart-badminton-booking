import React, { useMemo, useState } from 'react';
import { parseISO, differenceInMinutes, format } from 'date-fns';
import { vi } from 'date-fns/locale';
import { Court } from '../../../types/court.types';
import './TimelineResourceGrid.css';

export interface TimelineBooking {
  id: number;
  courtId: number;
  startTime: string; // ISO datetime
  endTime: string; // ISO datetime
  status: 'PENDING_PAYMENT' | 'CONFIRMED' | 'CHECKED_IN' | 'COMPLETED' | 'CANCELLED' | string;
  paymentStatus?: 'PAID' | 'UNPAID' | 'PENDING';
  bookingCode?: string;
  expiresAt?: string | null; // ISO datetime for PENDING_PAYMENT countdown
  // Booking details for preview
  userId?: number;
  user?: { id: number; name?: string; email: string; phone?: string };
  guestName?: string;
  guestPhone?: string;
  totalPrice?: number;
}

// NEW: Selected slot type for bulk booking
type SelectedSlot = {
  courtId: number;
  courtName: string;
  startTime: Date;
  endTime: Date;
  price: number;
};

// Booking preview modal data
interface BookingPreviewData {
  booking: TimelineBooking;
  courtName: string;
  style: { bg: string; text: string; label: string };
}

interface TimelineResourceGridProps {
  courts: Court[];
  bookings: TimelineBooking[];
  date: Date;
  startHour?: number;
  endHour?: number;
  selectedSlots?: SelectedSlot[]; // NEW: Array of selected slots
  onSlotToggle?: (courtId: number, startTime: Date) => void;
  onBookingClick?: (booking: TimelineBooking) => void; // NEW: External booking click handler
  isLoading?: boolean;
  // NEW: User info for permission control
  currentUserId?: number;
  userRole?: 'CUSTOMER' | 'STAFF' | 'ADMIN';
}

const DEFAULT_START_HOUR = 6;
const DEFAULT_END_HOUR = 21;
const SLOT_WIDTH_PX = 60; // ƒê·ªô r·ªông c·ªßa 1 gi·ªù (30 ph√∫t = SLOT_WIDTH_PX / 2)
const ROW_HEIGHT_PX = 80; // Chi·ªÅu cao m·ªói s√¢n

/**
 * T√≠nh to√°n m√†u s·∫Øc v√† tr·∫°ng th√°i hi·ªÉn th·ªã cho booking block
 */
const getBookingStyle = (booking: TimelineBooking) => {
  // Map tr·∫°ng th√°i booking ‚Üí m√†u s·∫Øc
  const statusColorMap: Record<
    string,
    { bg: string; text: string; label: string }
  > = {
    CONFIRMED: { bg: '#ef4444', text: '#ffffff', label: 'ƒê√£ ƒë·∫∑t' }, // Red
    CHECKED_IN: { bg: '#3b82f6', text: '#ffffff', label: 'ƒêang ch∆°i' }, // Blue - Playing
    PENDING_PAYMENT: {
      bg: '#f59e0b',
      text: '#ffffff',
      label: 'Ch·ªù thanh to√°n',
    }, // Amber
    COMPLETED: { bg: '#10b981', text: '#ffffff', label: 'Ho√†n th√†nh' }, // Green
    CANCELLED: { bg: '#9ca3af', text: '#ffffff', label: 'H·ªßy' }, // Gray
  };

  const style = statusColorMap[booking.status] || {
    bg: '#ef4444',
    text: '#ffffff',
    label: 'ƒê√£ ƒë·∫∑t',
  };

  // Calculate remaining time for PENDING_PAYMENT
  let remainingSeconds = 0;
  if (booking.status === 'PENDING_PAYMENT' && booking.expiresAt) {
    const now = Date.now();
    const expiresAt = new Date(booking.expiresAt).getTime();
    remainingSeconds = Math.max(0, Math.floor((expiresAt - now) / 1000));
  }

  return { ...style, remainingSeconds };
};

const TimelineResourceGrid: React.FC<TimelineResourceGridProps> = ({
  courts,
  bookings,
  date,
  startHour = DEFAULT_START_HOUR,
  endHour = DEFAULT_END_HOUR,
  selectedSlots = [], // NEW: Array-based selected slots
  onSlotToggle,
  onBookingClick, // NEW: External booking click handler
  isLoading = false,
  currentUserId,
  userRole = 'CUSTOMER',
}) => {
  const [hoveredSlot, setHoveredSlot] = useState<{
    courtId: number;
    hour: number;
  } | null>(null);

  // NEW: State for booking preview modal
  const [previewBooking, setPreviewBooking] = useState<BookingPreviewData | null>(null);

  // Check if user can view booking details
  const canViewBooking = (booking: TimelineBooking): boolean => {
    // Staff and Admin can view all bookings
    if (userRole === 'STAFF' || userRole === 'ADMIN') {
      return true;
    }
    // Customer can only view their own bookings
    if (userRole === 'CUSTOMER' && currentUserId) {
      return booking.userId === currentUserId || booking.user?.id === currentUserId;
    }
    return false;
  };

  // Handle booking click
  const handleBookingClick = (block: typeof bookingBlocks[0], courtName: string) => {
    // If external handler is provided (Admin mode), use it
    if (onBookingClick) {
      onBookingClick(block.rawBooking);
      return;
    }
    
    // Otherwise, show internal preview modal
    if (canViewBooking(block.rawBooking)) {
      setPreviewBooking({
        booking: block.rawBooking,
        courtName,
        style: block.style,
      });
    }
  };

  // T·∫°o danh s√°ch gi·ªù t·ª´ startHour ƒë·∫øn endHour
  const hours = useMemo(() => {
    const result = [];
    for (let i = startHour; i < endHour; i++) {
      result.push(i);
    }
    return result;
  }, [startHour, endHour]);

  // T√≠nh to√°n v·ªã tr√≠ v√† k√≠ch th∆∞·ªõc c·ªßa m·ªói booking block
  const bookingBlocks = useMemo(() => {
    return bookings
      .filter((booking) => {
        // Ch·ªâ l·∫•y booking c·ªßa ng√†y ƒë∆∞·ª£c ch·ªçn
        const bookingDate = format(parseISO(booking.startTime), 'yyyy-MM-dd');
        const selectedDate = format(date, 'yyyy-MM-dd');
        return bookingDate === selectedDate;
      })
      .map((booking) => {
        const start = parseISO(booking.startTime);
        const end = parseISO(booking.endTime);
        const durationMinutes = differenceInMinutes(end, start);
        const durationHours = durationMinutes / 60;

        // T√≠nh v·ªã tr√≠ b·∫Øt ƒë·∫ßu (t√≠nh t·ª´ startHour)
        const startOffsetMinutes =
          start.getHours() * 60 + start.getMinutes() - startHour * 60;
        const leftPx = (startOffsetMinutes / 60) * SLOT_WIDTH_PX;
        const widthPx = durationHours * SLOT_WIDTH_PX;

        const style = getBookingStyle(booking);

        return {
          id: booking.id,
          courtId: booking.courtId,
          leftPx,
          widthPx,
          durationMinutes,
          bookingCode: booking.bookingCode || `#${booking.id}`,
          style,
          rawBooking: booking,
        };
      });
  }, [bookings, date, startHour]);

  // L·∫•y bookings cho t·ª´ng s√¢n
  const getCourtBookings = (courtId: number) => {
    return bookingBlocks.filter((block) => block.courtId === courtId);
  };

  const handleSlotToggle = (
    courtId: number,
    hour: number,
    minute: number = 0,
  ) => {
    if (!onSlotToggle) return;

    const slotTime = new Date(date);
    slotTime.setHours(hour, minute, 0, 0);
    onSlotToggle(courtId, slotTime);
  };

  const totalHours = endHour - startHour;
  const totalWidthPx = totalHours * SLOT_WIDTH_PX;

  return (
    <div className="timeline-resource-grid-container">
      {isLoading ? (
        <div className="text-center py-8 text-gray-500">ƒêang t·∫£i l·ªãch...</div>
      ) : courts.length === 0 ? (
        <div className="text-center py-8 text-gray-500">
          Ch∆∞a c√≥ s√¢n kh·∫£ d·ª•ng
        </div>
      ) : (
        // ‚úÖ SINGLE SCROLL CONTAINER - Fix for Disconnected Scrolling
        <div className="timeline-scroll-container">
          <table className="timeline-table">
            <thead>
              <tr>
                {/* Corner Cell - Sticky both top & left */}
                <th className="timeline-corner-cell">
                  <div className="timeline-court-name-cell">S√¢n</div>
                </th>
                
                {/* Hour Headers - Sticky top */}
                {hours.map((hour) => (
                  <th
                    key={hour}
                    className="timeline-hour-header-cell"
                    style={{ minWidth: SLOT_WIDTH_PX, width: SLOT_WIDTH_PX }}
                  >
                    <span className="timeline-hour-label">
                      {String(hour).padStart(2, '0')}:00
                    </span>
                  </th>
                ))}
              </tr>
            </thead>
            <tbody>
              {courts.map((court, courtIdx) => (
                <tr key={court.id} className="timeline-court-row-tr">
                  {/* Court Name Cell - Sticky left */}
                  <td className="timeline-court-name-sticky" style={{ height: ROW_HEIGHT_PX }}>
                    <div className="timeline-court-name-cell" title={court.description}>
                      <div className="font-semibold text-gray-900">
                        {court.name}
                      </div>
                      <div className="text-xs text-gray-600">
                        {new Intl.NumberFormat('vi-VN', {
                          style: 'currency',
                          currency: 'VND',
                        }).format(Number(court.pricePerHour))}
                        {' / '}
                        {new Intl.NumberFormat('vi-VN', {
                          style: 'currency',
                          currency: 'VND',
                        }).format(Number((court as any).peakPricePerHour || court.pricePerHour * 2))}
                      </div>
                      <div className="text-[10px] text-gray-400">
                        Th∆∞·ªùng / Cao ƒëi·ªÉm (17h+)
                      </div>
                    </div>
                  </td>
                  
                  {/* Grid Cells - One cell per hour containing slots & bookings */}
                  {hours.map((hour) => (
                    <td key={`${court.id}-${hour}`} className="timeline-grid-cell" style={{ height: ROW_HEIGHT_PX }}>
                      <div className="timeline-cell-content" style={{ width: SLOT_WIDTH_PX, height: ROW_HEIGHT_PX }}>

            {/* Timeline Grid Body */}
            <div
              className="timeline-grid-body"
              style={{
                width: totalWidthPx,
                height: courts.length * ROW_HEIGHT_PX,
              }}
            >
              {/* Background grid lines */}
              {hours.map((hour, idx) => (
                <div
                  key={`grid-${hour}`}
                  className="timeline-grid-line"
                  style={{
                    left: idx * SLOT_WIDTH_PX,
                    width: SLOT_WIDTH_PX,
                    height: courts.length * ROW_HEIGHT_PX,
                  }}
                />
              ))}
              {/* Court rows with interactive slots */}
              {courts.map((court, courtIdx) => (
                <div
                  key={`court-${court.id}`}
                  className="timeline-court-row"
                  style={{
                    top: courtIdx * ROW_HEIGHT_PX,
                    height: ROW_HEIGHT_PX,
                    width: totalWidthPx,
                  }}
                >
                  {/* Interactive 30-minute slots */}
                  {hours.map((hour) => (
                    <React.Fragment key={`slots-${hour}`}>
                      {/* 0-30 min */}
                      <div
                        className="timeline-slot"
                        style={{
                          left: (hour - startHour) * SLOT_WIDTH_PX,
                          width: SLOT_WIDTH_PX / 2,
                          height: ROW_HEIGHT_PX,
                        }}
                        onMouseEnter={() =>
                          setHoveredSlot({ courtId: court.id, hour })
                        }
                        onMouseLeave={() => setHoveredSlot(null)}
                        onClick={() => handleSlotToggle(court.id, hour, 0)}
                      />

                      {/* 30-60 min */}
                      <div
                        className="timeline-slot"
                        style={{
                          left:
                            (hour - startHour) * SLOT_WIDTH_PX +
                            SLOT_WIDTH_PX / 2,
                          width: SLOT_WIDTH_PX / 2,
                          height: ROW_HEIGHT_PX,
                        }}
                        onMouseEnter={() =>
                          setHoveredSlot({ courtId: court.id, hour })
                        }
                        onMouseLeave={() => setHoveredSlot(null)}
                        onClick={() => handleSlotToggle(court.id, hour, 30)}
                      />
                    </React.Fragment>
                  ))}

                  {/* Booking blocks */}
                  {getCourtBookings(court.id).map((block) => {
                    const isClickable = canViewBooking(block.rawBooking);
                    return (
                    <div
                      key={`booking-${block.id}`}
                      className={`timeline-booking-block ${isClickable ? 'cursor-pointer hover:opacity-90 hover:ring-2 hover:ring-white hover:ring-offset-1' : 'cursor-not-allowed'}`}
                      style={{
                        left: block.leftPx,
                        width: Math.max(block.widthPx, 30), // Min width to show label
                        backgroundColor: block.style.bg,
                        color: block.style.text,
                        height: ROW_HEIGHT_PX * 0.8,
                        top: ROW_HEIGHT_PX * 0.1,
                      }}
                      onClick={() => handleBookingClick(block, court.name)}
                      title={isClickable 
                        ? `üîç Click ƒë·ªÉ xem chi ti·∫øt - ${block.style.label}`
                        : `${block.style.label} - ${block.durationMinutes}min${
                        block.style.remainingSeconds
                          ? ` (${Math.ceil(block.style.remainingSeconds / 60)}p c√≤n l·∫°i)`
                          : ''
                      }`}
                    >
                      <div className="timeline-booking-label">
                        {block.durationMinutes >= 30 && (
                          <>
                            <div className="text-xs font-bold">
                              {block.bookingCode}
                            </div>
                            {block.style.remainingSeconds ? (
                              <div className="text-xs">
                                ‚è± {Math.ceil(block.style.remainingSeconds / 60)}
                                p
                              </div>
                            ) : (
                              <div className="text-xs">
                                {block.durationMinutes}p
                              </div>
                            )}
                          </>
                        )}
                      </div>
                    </div>
                  );})}

                  {/* NEW: Multi-slot selection highlights - render all selected slots */}
                  {selectedSlots
                    .filter((slot) => slot.courtId === court.id)
                    .map((slot, idx) => {
                      const startOffsetMinutes =
                        slot.startTime.getHours() * 60 +
                        slot.startTime.getMinutes() -
                        startHour * 60;
                      const leftPx = (startOffsetMinutes / 60) * SLOT_WIDTH_PX;
                      const durationMinutes =
                        (slot.endTime.getTime() - slot.startTime.getTime()) /
                        60000;
                      const widthPx = (durationMinutes / 60) * SLOT_WIDTH_PX;

                      return (
                        <div
                          key={`selected-${slot.courtId}-${slot.startTime.getTime()}-${idx}`}
                          className="timeline-selection-block"
                          style={{
                            left: leftPx,
                            width: widthPx,
                            height: ROW_HEIGHT_PX * 0.8,
                            top: ROW_HEIGHT_PX * 0.1,
                            backgroundColor: '#fbbf24', // Yellow for selected
                            border: '2px solid #f59e0b',
                            zIndex: 10,
                          }}
                          title={`‚úÖ ƒê√£ ch·ªçn: ${format(slot.startTime, 'HH:mm')} - ${format(
                            slot.endTime,
                            'HH:mm',
                          )} ‚Ä¢ ${new Intl.NumberFormat('vi-VN', {
                            style: 'currency',
                            currency: 'VND',
                          }).format(slot.price)}`}
                        >
                          <div className="timeline-selection-label">
                            <div className="text-xs font-bold text-gray-900">
                              ‚úì {format(slot.startTime, 'HH:mm')}
                            </div>
                          </div>
                        </div>
                      );
                    })}
                </div>
              ))}
              ```{' '}
            </div>
          </div>
        </div>
      )}

      {/* Legend */}
      {!isLoading && bookings.length > 0 && (
        <div className="timeline-legend">
          <div className="legend-item">
            <div
              className="legend-color"
              style={{ backgroundColor: '#ef4444' }}
            ></div>
            <span>ƒê√£ ƒë·∫∑t</span>
          </div>
          <div className="legend-item">
            <div
              className="legend-color"
              style={{ backgroundColor: '#3b82f6' }}
            ></div>
            <span>ƒêang ch∆°i</span>
          </div>
          <div className="legend-item">
            <div
              className="legend-color"
              style={{ backgroundColor: '#f59e0b' }}
            ></div>
            <span>Ch·ªù thanh to√°n</span>
          </div>
          <div className="legend-item">
            <div
              className="legend-color"
              style={{ backgroundColor: '#10b981' }}
            ></div>
            <span>Ho√†n th√†nh</span>
          </div>
          <div className="legend-item">
            <div
              className="legend-color"
              style={{ backgroundColor: '#9ca3af' }}
            ></div>
            <span>H·ªßy</span>
          </div>
          <div className="legend-item">
            <div
              className="legend-color"
              style={{
                backgroundColor: '#ffffff',
                border: '1px solid #d1d5db',
              }}
            ></div>
            <span>Tr·ªëng</span>
          </div>
        </div>
      )}

      {/* Booking Preview Modal */}
      {previewBooking && (
        <div 
          className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
          onClick={() => setPreviewBooking(null)}
        >
          <div 
            className="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 overflow-hidden"
            onClick={(e) => e.stopPropagation()}
          >
            {/* Modal Header */}
            <div 
              className="px-6 py-4 text-white"
              style={{ backgroundColor: previewBooking.style.bg }}
            >
              <div className="flex items-center justify-between">
                <div>
                  <h3 className="text-lg font-bold">
                    üè∏ {previewBooking.courtName}
                  </h3>
                  <p className="text-sm opacity-90">{previewBooking.style.label}</p>
                </div>
                <button 
                  onClick={() => setPreviewBooking(null)}
                  className="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-1 transition-colors"
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
            </div>

            {/* Modal Body */}
            <div className="px-6 py-4 space-y-4">
              {/* Booking Code */}
              <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                <span className="text-2xl">üé´</span>
                <div>
                  <p className="text-xs text-gray-500">M√£ ƒë·∫∑t s√¢n</p>
                  <p className="font-mono font-bold text-lg text-gray-900">
                    {previewBooking.booking.bookingCode || `#${previewBooking.booking.id}`}
                  </p>
                </div>
              </div>

              {/* Customer Info */}
              <div className="space-y-3">
                <div className="flex items-start gap-3">
                  <span className="text-xl">üë§</span>
                  <div className="flex-1">
                    <p className="text-xs text-gray-500">T√™n kh√°ch h√†ng</p>
                    <p className="font-semibold text-gray-900">
                      {previewBooking.booking.guestName || 
                       previewBooking.booking.user?.name || 
                       'Ch∆∞a c√≥ th√¥ng tin'}
                    </p>
                  </div>
                </div>

                <div className="flex items-start gap-3">
                  <span className="text-xl">üìû</span>
                  <div className="flex-1">
                    <p className="text-xs text-gray-500">S·ªë ƒëi·ªán tho·∫°i</p>
                    <p className="font-semibold text-gray-900">
                      {previewBooking.booking.guestPhone || 
                       previewBooking.booking.user?.phone || 
                       'Ch∆∞a c√≥ th√¥ng tin'}
                    </p>
                  </div>
                </div>

                <div className="flex items-start gap-3">
                  <span className="text-xl">‚è∞</span>
                  <div className="flex-1">
                    <p className="text-xs text-gray-500">Th·ªùi gian ch∆°i</p>
                    <p className="font-semibold text-gray-900">
                      {format(parseISO(previewBooking.booking.startTime), 'HH:mm')} - {format(parseISO(previewBooking.booking.endTime), 'HH:mm')}
                    </p>
                    <p className="text-sm text-gray-500">
                      {format(parseISO(previewBooking.booking.startTime), 'EEEE, dd/MM/yyyy', { locale: vi })}
                    </p>
                  </div>
                </div>

                <div className="flex items-start gap-3">
                  <span className="text-xl">üí∞</span>
                  <div className="flex-1">
                    <p className="text-xs text-gray-500">S·ªë ti·ªÅn</p>
                    <p className="font-bold text-xl text-green-600">
                      {previewBooking.booking.totalPrice 
                        ? new Intl.NumberFormat('vi-VN', {
                            style: 'currency',
                            currency: 'VND',
                          }).format(Number(previewBooking.booking.totalPrice))
                        : 'Ch∆∞a c√≥ th√¥ng tin'}
                    </p>
                    <p className="text-xs text-gray-500">
                      {previewBooking.booking.paymentStatus === 'PAID' 
                        ? '‚úÖ ƒê√£ thanh to√°n' 
                        : previewBooking.booking.paymentStatus === 'UNPAID'
                        ? '‚è≥ Ch∆∞a thanh to√°n'
                        : ''}
                    </p>
                  </div>
                </div>
              </div>
            </div>

            {/* Modal Footer */}
            <div className="px-6 py-4 bg-gray-50 border-t">
              <button
                onClick={() => setPreviewBooking(null)}
                className="w-full bg-gray-800 text-white py-2 rounded-lg hover:bg-gray-700 transition-colors font-medium"
              >
                ƒê√≥ng
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default TimelineResourceGrid;
