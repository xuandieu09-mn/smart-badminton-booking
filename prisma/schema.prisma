// File: prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum Role {
  CUSTOMER
  STAFF
  ADMIN
}

enum BookingStatus {
  PENDING_PAYMENT // Waiting for payment (15 min)
  CONFIRMED       // Payment received
  CHECKED_IN      // Customer checked in
  COMPLETED       // Session completed
  CANCELLED       // Cancelled (> 24h before)
  CANCELLED_LATE  // Late cancellation (< 24h before)
  EXPIRED         // Payment timeout expired
  BLOCKED         // Maintenance block (Admin)
}

enum BookingType {
  REGULAR     // Normal booking
  MAINTENANCE // Court maintenance
}

enum PaymentMethod {
  VNPAY
  MOMO
  WALLET
  CASH
}

enum PaymentStatus {
  UNPAID
  PAID
  REFUNDED
  FAILED
}

enum WalletTransactionType {
  DEPOSIT          // Add money
  REFUND           // Refund from cancellation
  PAYMENT          // Pay for booking
  ADMIN_ADJUSTMENT // Admin manual adjustment
}

// ==================== MODELS ====================

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  name      String?
  role      Role     @default(CUSTOMER)
  isActive  Boolean  @default(true) // Allow deactivating accounts

  // 1 user has many bookings
  bookings             Booking[] @relation("UserBookings")
  // 1 user has 1 wallet
  wallet               Wallet?
  // Staff can create bookings for guests
  staffCreatedBookings Booking[] @relation("StaffCreatedBookings")
  // Staff can check in bookings
  staffCheckedIns      Booking[] @relation("StaffCheckedIn")
  // Admin actions (audit log)
  adminActions         AdminAction[]
  // Staff sales (POS)
  staffSales           Sale[]        @relation("StaffSales")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Court {
  id           Int     @id @default(autoincrement())
  name         String
  description  String?
  pricePerHour Decimal @default(50000)
  isActive     Boolean @default(true)

  // 1 court has many bookings
  bookings     Booking[]
  // 1 court has many pricing rules
  pricingRules PricingRule[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Booking {
  id          Int    @id @default(autoincrement())
  bookingCode String @unique // 6-character code (e.g. "AB1234")

  // Relations
  courtId Int
  court   Court @relation(fields: [courtId], references: [id])

  userId Int? // Nullable for Guest bookings
  user   User? @relation("UserBookings", fields: [userId], references: [id])

  // Guest info (when userId = NULL)
  guestName  String?
  guestPhone String?

  // Time
  startTime DateTime
  endTime   DateTime

  // Pricing
  totalPrice Decimal

  // Status
  status BookingStatus @default(PENDING_PAYMENT)
  type   BookingType   @default(REGULAR)

  // Payment
  paymentMethod PaymentMethod?
  paymentStatus PaymentStatus  @default(UNPAID)

  // Metadata
  createdBy        String // "CUSTOMER" | "STAFF" | "ADMIN"
  createdByStaffId Int?
  createdByStaff   User?  @relation("StaffCreatedBookings", fields: [createdByStaffId], references: [id])

  // Check-in
  checkedInAt        DateTime?
  checkedInByStaffId Int?
  checkedInByStaff   User?  @relation("StaffCheckedIn", fields: [checkedInByStaffId], references: [id])

  // Expiry (for PENDING_PAYMENT status)
  expiresAt DateTime?

  // QR Code (Day 14 - generated after payment)
  qrCode String? @db.Text // Base64 encoded QR code image

  // Recurring Booking Support (Day 15)
  isRecurring        Boolean  @default(false)
  recurrenceGroupId  String?  // Link all bookings in same recurring series
  recurrencePattern  String?  // "WEEKLY" | "BIWEEKLY" | "MONTHLY"
  recurrenceDayOfWeek Int?    // 0=Sunday, 1=Monday, ..., 6=Saturday

  // Relations
  payment            Payment?
  cancellation       BookingCancellation?
  walletTransactions WalletTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([recurrenceGroupId])

  // IMPORTANT: Exclusion Constraint is added in migration SQL
}

model Wallet {
  id     Int @id @default(autoincrement())
  userId Int @unique
  user   User @relation(fields: [userId], references: [id])

  balance Decimal @default(0) // Current balance

  transactions WalletTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WalletTransaction {
  id       Int    @id @default(autoincrement())
  walletId Int
  wallet   Wallet @relation(fields: [walletId], references: [id])

  type   WalletTransactionType
  amount Decimal

  // Reference
  bookingId   Int?
  booking     Booking? @relation(fields: [bookingId], references: [id])
  description String?

  balanceBefore Decimal
  balanceAfter  Decimal

  createdAt DateTime @default(now())

  @@index([walletId])
  @@index([bookingId])
}

model Payment {
  id        Int     @id @default(autoincrement())
  bookingId Int     @unique
  booking   Booking @relation(fields: [bookingId], references: [id])

  method PaymentMethod
  amount Decimal

  // VNPay/Momo data
  transactionId   String? // Transaction ID from payment gateway
  gatewayResponse Json?   // Raw response from gateway

  status PaymentStatus @default(UNPAID)
  paidAt DateTime?

  createdAt DateTime @default(now())
}

model PricingRule {
  id Int @id @default(autoincrement())

  courtId Int? // NULL = applies to all courts
  court   Court? @relation(fields: [courtId], references: [id])

  name String // e.g. "Golden hours", "Weekend"

  // Conditions
  dayOfWeek Int?   // 0=Sun, 1=Mon, ..., 6=Sat (NULL = all days)
  startTime String // "17:00:00"
  endTime   String // "21:00:00"

  // Price
  pricePerHour Decimal
  priority     Int     @default(0) // Higher priority rules take precedence

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BookingCancellation {
  id        Int     @id @default(autoincrement())
  bookingId Int     @unique
  booking   Booking @relation(fields: [bookingId], references: [id])

  cancelledBy     Int  // User ID (Customer/Staff/Admin)
  cancelledByRole Role
  reason          String?

  refundAmount Decimal @default(0)
  refundMethod String? // "WALLET", "NONE"

  createdAt DateTime @default(now())
}

model AdminAction {
  id      Int  @id @default(autoincrement())
  adminId Int
  admin   User @relation(fields: [adminId], references: [id])

  action     String // "CANCEL_BOOKING", "REFUND", "BLOCK_COURT"
  targetType String // "Booking", "User", "Court"
  targetId   Int
  reason     String?
  metadata   Json? // Additional data

  createdAt DateTime @default(now())
}

// ==================== POS SYSTEM (Point of Sale) ====================

enum ProductCategory {
  SHUTTLECOCK
  BEVERAGE
  ACCESSORY
  EQUIPMENT
  OTHER
}

model Product {
  id          Int             @id @default(autoincrement())
  name        String
  description String?
  category    ProductCategory
  price       Decimal
  stock       Int             @default(0)
  imageUrl    String?
  isActive    Boolean         @default(true)

  saleItems SaleItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
}

model Sale {
  id            Int      @id @default(autoincrement())
  saleCode      String   @unique
  totalAmount   Decimal
  paymentMethod String   @default("CASH")
  
  staffId Int
  staff   User @relation("StaffSales", fields: [staffId], references: [id])

  customerId   Int?
  customerName String?
  
  bookingId Int?

  items SaleItem[]

  createdAt DateTime @default(now())

  @@index([staffId])
  @@index([createdAt])
}

model SaleItem {
  id        Int     @id @default(autoincrement())
  saleId    Int
  sale      Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  productId Int
  product   Product @relation(fields: [productId], references: [id])

  quantity  Int
  unitPrice Decimal
  subtotal  Decimal

  @@index([saleId])
  @@index([productId])
}