generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   Int               @id @default(autoincrement())
  email                String            @unique
  password             String
  name                 String?
  role                 Role              @default(CUSTOMER)
  createdAt            DateTime          @default(now())
  isActive             Boolean           @default(true)
  updatedAt            DateTime          @updatedAt
  phone                String?
  adminActions         AdminAction[]
  staffCheckedIns      Booking[]         @relation("StaffCheckedIn")
  staffCreatedBookings Booking[]         @relation("StaffCreatedBookings")
  bookings             Booking[]         @relation("UserBookings")
  bookingGroups        BookingGroup[]
  inventoryActions     InventoryAction[]
  notifications        Notification[]
  staffSales           Sale[]            @relation("StaffSales")
  wallet               Wallet?
}

model Court {
  id               Int            @id @default(autoincrement())
  name             String
  description      String?
  pricePerHour     Decimal        @default(50000)
  isActive         Boolean        @default(true)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  peakPricePerHour Decimal        @default(100000)
  bookings         Booking[]
  bookingGroups    BookingGroup[]
  pricingRules     PricingRule[]
}

model Booking {
  id                  Int                  @id @default(autoincrement())
  courtId             Int
  userId              Int?
  startTime           DateTime
  endTime             DateTime
  totalPrice          Decimal
  status              BookingStatus        @default(PENDING_PAYMENT)
  createdAt           DateTime             @default(now())
  bookingCode         String               @unique
  guestName           String?
  guestPhone          String?
  type                BookingType          @default(REGULAR)
  paymentMethod       PaymentMethod?
  paymentStatus       PaymentStatus        @default(UNPAID)
  createdBy           String
  createdByStaffId    Int?
  checkedInAt         DateTime?
  checkedInByStaffId  Int?
  expiresAt           DateTime?
  updatedAt           DateTime             @updatedAt
  isRecurring         Boolean              @default(false)
  qrCode              String?
  recurrenceDayOfWeek Int?
  recurrenceGroupId   String?
  recurrencePattern   String?
  paidAmount          Decimal              @default(0)
  bookingGroupId      Int?
  bookingGroup        BookingGroup?        @relation(fields: [bookingGroupId], references: [id])
  checkedInByStaff    User?                @relation("StaffCheckedIn", fields: [checkedInByStaffId], references: [id])
  court               Court                @relation(fields: [courtId], references: [id])
  createdByStaff      User?                @relation("StaffCreatedBookings", fields: [createdByStaffId], references: [id])
  user                User?                @relation("UserBookings", fields: [userId], references: [id])
  cancellation        BookingCancellation?
  payment             Payment?
  walletTransactions  WalletTransaction[]

  @@index([recurrenceGroupId])
  @@index([bookingGroupId])
}

model BookingGroup {
  id                  Int                @id @default(autoincrement())
  userId              Int
  courtId             Int
  startDate           DateTime
  endDate             DateTime
  startTime           String
  endTime             String
  totalPrice          Decimal            @db.Decimal(10, 2)
  totalPaid           Decimal            @default(0) @db.Decimal(10, 2)
  paymentStatus       PaymentStatus      @default(UNPAID)
  paymentMethod       PaymentMethod?
  groupPaymentId      String?
  groupPaymentGateway Json?
  isActive            Boolean            @default(true)
  createdBy           String
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  discountRate        Decimal            @default(0) @db.Decimal(5, 2)
  finalPrice          Decimal            @db.Decimal(10, 2)
  originalPrice       Decimal            @db.Decimal(10, 2)
  status              BookingGroupStatus @default(CONFIRMED)
  totalSessions       Int
  daysOfWeek          Int[]
  bookings            Booking[]
  court               Court              @relation(fields: [courtId], references: [id])
  user                User               @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([courtId])
}

model Wallet {
  id           Int                 @id @default(autoincrement())
  userId       Int                 @unique
  balance      Decimal             @default(0)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  user         User                @relation(fields: [userId], references: [id])
  transactions WalletTransaction[]
}

model WalletTransaction {
  id            Int                   @id @default(autoincrement())
  walletId      Int
  type          WalletTransactionType
  amount        Decimal
  bookingId     Int?
  description   String?
  balanceBefore Decimal
  balanceAfter  Decimal
  createdAt     DateTime              @default(now())
  booking       Booking?              @relation(fields: [bookingId], references: [id])
  wallet        Wallet                @relation(fields: [walletId], references: [id])

  @@index([walletId])
  @@index([bookingId])
}

model Payment {
  id              Int           @id @default(autoincrement())
  bookingId       Int           @unique
  method          PaymentMethod
  amount          Decimal
  transactionId   String?
  gatewayResponse Json?
  status          PaymentStatus @default(UNPAID)
  paidAt          DateTime?
  createdAt       DateTime      @default(now())
  booking         Booking       @relation(fields: [bookingId], references: [id])
}

model PricingRule {
  id           Int      @id @default(autoincrement())
  courtId      Int?
  name         String
  dayOfWeek    Int?
  startTime    String
  endTime      String
  pricePerHour Decimal
  priority     Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  court        Court?   @relation(fields: [courtId], references: [id])
}

model BookingCancellation {
  id              Int      @id @default(autoincrement())
  bookingId       Int      @unique
  cancelledBy     Int
  cancelledByRole Role
  reason          String?
  refundAmount    Decimal  @default(0)
  refundMethod    String?
  createdAt       DateTime @default(now())
  booking         Booking  @relation(fields: [bookingId], references: [id])
}

model AdminAction {
  id         Int      @id @default(autoincrement())
  adminId    Int
  action     String
  targetType String
  targetId   Int
  reason     String?
  metadata   Json?
  createdAt  DateTime @default(now())
  admin      User     @relation(fields: [adminId], references: [id])
}

model Product {
  id               Int               @id @default(autoincrement())
  name             String
  description      String?
  category         ProductCategory
  price            Decimal
  stock            Int               @default(0)
  imageUrl         String?
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  inventoryActions InventoryAction[]
  saleItems        SaleItem[]

  @@index([category])
}

model InventoryAction {
  id              Int                 @id @default(autoincrement())
  productId       Int
  type            InventoryActionType
  quantityChange  Int?
  oldPrice        Decimal?
  newPrice        Decimal?
  reason          String?
  saleId          Int?
  performedBy     Int
  createdAt       DateTime            @default(now())
  performedByUser User                @relation(fields: [performedBy], references: [id])
  product         Product             @relation(fields: [productId], references: [id])
  sale            Sale?               @relation(fields: [saleId], references: [id])

  @@index([productId])
  @@index([type])
  @@index([createdAt])
}

model Sale {
  id               Int               @id @default(autoincrement())
  saleCode         String            @unique
  totalAmount      Decimal
  paymentMethod    String            @default("CASH")
  staffId          Int
  customerId       Int?
  customerName     String?
  bookingId        Int?
  createdAt        DateTime          @default(now())
  inventoryActions InventoryAction[]
  staff            User              @relation("StaffSales", fields: [staffId], references: [id])
  items            SaleItem[]

  @@index([staffId])
  @@index([createdAt])
}

model SaleItem {
  id        Int     @id @default(autoincrement())
  saleId    Int
  productId Int
  quantity  Int
  unitPrice Decimal
  subtotal  Decimal
  product   Product @relation(fields: [productId], references: [id])
  sale      Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([saleId])
  @@index([productId])
}

model Notification {
  id        Int              @id @default(autoincrement())
  userId    Int?
  title     String
  message   String
  type      NotificationType @default(INFO)
  metadata  Json?
  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())
  user      User?            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
}

enum Role {
  CUSTOMER
  STAFF
  ADMIN
}

enum BookingStatus {
  PENDING_PAYMENT
  CONFIRMED
  CHECKED_IN
  COMPLETED
  CANCELLED
  CANCELLED_LATE
  EXPIRED
  BLOCKED
}

enum BookingType {
  REGULAR
  MAINTENANCE
}

enum PaymentMethod {
  VNPAY
  MOMO
  WALLET
  CASH
}

enum PaymentStatus {
  UNPAID
  PAID
  REFUNDED
  FAILED
}

enum BookingGroupStatus {
  PENDING_PAYMENT
  CONFIRMED
  CANCELLED
}

enum WalletTransactionType {
  DEPOSIT
  REFUND
  PAYMENT
  ADMIN_ADJUSTMENT
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

enum ProductCategory {
  SHUTTLECOCK
  BEVERAGE
  ACCESSORY
  EQUIPMENT
  OTHER
}

enum InventoryActionType {
  RESTOCK
  PRICE_UPDATE
  DAMAGE
  SALE
}
